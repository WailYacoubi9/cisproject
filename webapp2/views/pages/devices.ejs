<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <%- include('../partials/header') %>

        <main class="container">
            <div class="page-header">
                <h1 class="page-title">
                    <span class="icon">üì±</span>
                    Mes Appareils
                </h1>
                <div style="display: flex; gap: 1rem;">
                    <a href="/" class="btn btn-secondary">
                        Retour
                    </a>
                    <a href="/logout" class="btn btn-logout">
                        D√©connexion
                    </a>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Gestion des appareils connect√©s</h3>
                <p class="card-description">
                    Cette section permettra de g√©rer les appareils connect√©s √† votre compte via le Device Flow OAuth2.
                </p>

                <% if (devices && devices.length > 0) { %>
                    <div class="devices-list">
                        <h3 class="card-title">üì± Appareils connect√©s</h3>
                        <p class="card-description" style="margin-bottom: 20px;">
                            Liste des appareils authentifi√©s via le Device Flow OAuth2 (r√©cup√©r√©s depuis Keycloak).
                        </p>

                        <% devices.forEach((device, index) => { %>
                            <% device.sessions.forEach((session, sessionIndex) => { %>
                                <%
                                    // Filtrer pour ne montrer que le client devicecis
                                    const deviceClients = session.clients ? session.clients.filter(c => c.clientId === 'devicecis') : [];
                                %>
                                <% if (deviceClients.length > 0) { %>
                                <div class="device-card" style="background: white; border: 2px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h4 style="margin: 0 0 15px 0; color: #047857; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.5rem;">üíª</span>
                                        Device #<%= (index * device.sessions.length + sessionIndex + 1) %>
                                    </h4>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f9fafb; padding: 15px; border-radius: 5px;">
                                        <div>
                                            <p style="margin: 5px 0; color: #374151;"><strong>üìç Adresse IP:</strong> <%= session.ipAddress %></p>
                                            <p style="margin: 5px 0; color: #374151;"><strong>üÜî Session ID:</strong> <code style="background: #e5e7eb; padding: 2px 6px; border-radius: 3px; font-size: 0.85rem; color: #1f2937;"><%= session.id.substring(0, 20) %>...</code></p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0; color: #374151;"><strong>üïê Connect√© le:</strong> <%= new Date(session.started * 1000).toLocaleString('fr-FR') %></p>
                                            <p style="margin: 5px 0; color: #374151;"><strong>‚è∞ Derni√®re activit√©:</strong> <%= new Date(session.lastAccess * 1000).toLocaleString('fr-FR') %></p>
                                        </div>
                                    </div>

                                    <% if (session.expires) { %>
                                        <p style="margin: 15px 0 5px 0; color: #374151;"><strong>‚åõ Expire le:</strong> <%= new Date(session.expires * 1000).toLocaleString('fr-FR') %></p>
                                    <% } %>

                                    <div style="margin-top: 15px; padding: 12px; background: #d1fae5; border-radius: 5px; border-left: 4px solid #10b981;">
                                        <% deviceClients.forEach(client => { %>
                                            <p style="margin: 0; color: #065f46; font-weight: 600;">
                                                ‚úì <%= client.clientName || client.clientId %>
                                                <% if (client.clientId !== client.clientName) { %>
                                                    <span style="color: #047857; font-size: 0.9rem; font-weight: 400;"> (<code><%= client.clientId %></code>)</span>
                                                <% } %>
                                            </p>
                                        <% }); %>
                                    </div>
                                </div>
                                <% } %>
                            <% }); %>
                        <% }); %>

                        <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 5px;">
                            <p style="margin: 0; color: #166534;">
                                <strong>‚úÖ Architecture correcte:</strong> Les devices sont r√©cup√©r√©s depuis Keycloak Account API
                                (source unique de v√©rit√©). WebApp n'interroge jamais device-app directement.
                            </p>
                        </div>
                    </div>
                <% } else { %>
                    <div class="info-box">
                        <div class="info-icon">üìµ</div>
                        <div class="info-content">
                            <h4>Aucun appareil connect√©</h4>
                            <p>D√©marrez device-app sur <a href="http://localhost:4000" target="_blank" style="color: #3b82f6; font-weight: 600;">http://localhost:4000</a> et authentifiez-vous pour voir vos appareils ici.</p>
                            <p style="margin-top: 10px; color: #6b7280; font-size: 0.95rem;">
                                Les appareils authentifi√©s via le Device Flow OAuth2 appara√Ætront automatiquement dans cette liste.
                            </p>
                        </div>
                    </div>
                <% } %>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="location.reload()" class="btn btn-primary">
                        üîÑ Actualiser la liste
                    </button>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üîó</div>
                    <h3>Association d'appareils</h3>
                    <p>Connectez vos appareils embarqu√©s (Raspberry Pi, box TV, etc.) sans clavier via un code
                        d'appairage</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîç</div>
                    <h3>Liste des appareils</h3>
                    <p>Visualisez tous les appareils associ√©s √† votre compte avec leur statut et derni√®re connexion</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ùå</div>
                    <h3>R√©vocation</h3>
                    <p>R√©voquez l'acc√®s √† distance de n'importe quel appareil en un clic pour renforcer votre s√©curit√©
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Historique</h3>
                    <p>Consultez l'historique des connexions et des activit√©s de chaque appareil</p>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Prochaines √©tapes</h3>
                <ul class="checklist">
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Configurer le client "devicecis" dans Keycloak avec Device Authorization Grant
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        D√©velopper l'application embarqu√©e (Raspberry Pi / PC)
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Impl√©menter l'affichage du QR code pour faciliter l'appairage
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Cr√©er l'interface de gestion des appareils sur cette page
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Ajouter la fonctionnalit√© de r√©vocation de tokens
                    </li>
                </ul>
            </div>
        </main>

        <%- include('../partials/footer') %>

            <script src="/js/main.js"></script>
</body>

</html>