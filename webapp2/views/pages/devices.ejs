<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <%- include('../partials/header') %>

        <main class="container">
            <div class="page-header">
                <h1 class="page-title">
                    <span class="icon">üì±</span>
                    Mes Appareils
                </h1>
                <div style="display: flex; gap: 1rem;">
                    <a href="/" class="btn btn-secondary">
                        Retour
                    </a>
                    <a href="/logout" class="btn btn-logout">
                        D√©connexion
                    </a>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Gestion des appareils connect√©s</h3>
                <p class="card-description">
                    Cette section permettra de g√©rer les appareils connect√©s √† votre compte via le Device Flow OAuth2.
                </p>

                <% if (devices && devices.length > 0) { %>
                    <div class="devices-list">
                        <h3 class="card-title">üì± Appareils connect√©s</h3>
                        <p class="card-description" style="margin-bottom: 20px;">
                            Liste des appareils authentifi√©s via le Device Flow OAuth2 (r√©cup√©r√©s depuis Keycloak).
                        </p>

                        <% devices.forEach((device, index) => { %>
                            <% device.sessions.forEach((session, sessionIndex) => { %>
                                <div class="device-card" style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                    <h4 style="margin: 0 0 15px 0; color: #1e40af; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.5rem;">üíª</span>
                                        Device #<%= (index * device.sessions.length + sessionIndex + 1) %>
                                    </h4>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <p style="margin: 5px 0;"><strong>üìç Adresse IP:</strong> <%= session.ipAddress %></p>
                                            <p style="margin: 5px 0;"><strong>üÜî Session ID:</strong> <code style="background: #e0e7ff; padding: 2px 6px; border-radius: 3px; font-size: 0.85rem;"><%= session.id.substring(0, 20) %>...</code></p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0;"><strong>üïê Connect√© le:</strong> <%= new Date(session.started).toLocaleString('fr-FR') %></p>
                                            <p style="margin: 5px 0;"><strong>‚è∞ Derni√®re activit√©:</strong> <%= new Date(session.lastAccess).toLocaleString('fr-FR') %></p>
                                        </div>
                                    </div>

                                    <% if (session.expires) { %>
                                        <p style="margin: 10px 0 5px 0;"><strong>‚åõ Expire le:</strong> <%= new Date(session.expires).toLocaleString('fr-FR') %></p>
                                    <% } %>

                                    <% if (session.clients && session.clients.length > 0) { %>
                                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bfdbfe;">
                                            <p style="margin: 0 0 8px 0; font-weight: 600; color: #1e40af;">Clients OAuth2:</p>
                                            <% session.clients.forEach(client => { %>
                                                <div style="background: white; padding: 8px 12px; border-radius: 5px; margin-bottom: 5px;">
                                                    <span style="color: #059669; font-weight: 600;">‚úì <%= client.clientName || client.clientId %></span>
                                                    <% if (client.clientId !== client.clientName) { %>
                                                        <span style="color: #6b7280; font-size: 0.9rem;"> (<code><%= client.clientId %></code>)</span>
                                                    <% } %>
                                                </div>
                                            <% }); %>
                                        </div>
                                    <% } %>
                                </div>
                            <% }); %>
                        <% }); %>

                        <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 5px;">
                            <p style="margin: 0; color: #166534;">
                                <strong>‚úÖ Architecture correcte:</strong> Les devices sont r√©cup√©r√©s depuis Keycloak Account API
                                (source unique de v√©rit√©). WebApp n'interroge jamais device-app directement.
                            </p>
                        </div>
                    </div>
                <% } else { %>
                    <div class="info-box">
                        <div class="info-icon">üìµ</div>
                        <div class="info-content">
                            <h4>Aucun appareil connect√©</h4>
                            <p>D√©marrez device-app sur <a href="http://localhost:4000" target="_blank" style="color: #3b82f6; font-weight: 600;">http://localhost:4000</a> et authentifiez-vous pour voir vos appareils ici.</p>
                            <p style="margin-top: 10px; color: #6b7280; font-size: 0.95rem;">
                                Les appareils authentifi√©s via le Device Flow OAuth2 appara√Ætront automatiquement dans cette liste.
                            </p>
                        </div>
                    </div>
                <% } %>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="location.reload()" class="btn btn-primary">
                        üîÑ Actualiser la liste
                    </button>
                </div>
            </div>
        </main>

        <%- include('../partials/footer') %>

            <script src="/js/main.js"></script>
</body>

</html>