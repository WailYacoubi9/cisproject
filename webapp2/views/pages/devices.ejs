<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <%- include('../partials/header') %>

        <main class="container">
            <div class="page-header">
                <h1 class="page-title">
                    <span class="icon">üì±</span>
                    Mes Appareils
                </h1>
                <div style="display: flex; gap: 1rem;">
                    <a href="/" class="btn btn-secondary">
                        Retour
                    </a>
                    <a href="/logout" class="btn btn-logout">
                        D√©connexion
                    </a>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Gestion des appareils connect√©s</h3>
                <p class="card-description">
                    Cette section permettra de g√©rer les appareils connect√©s √† votre compte via le Device Flow OAuth2.
                </p>

                <div class="info-box">
                    <div class="info-icon">üöß</div>
                    <div class="info-content">
                        <% if (typeof deviceStatus !== 'undefined' && deviceStatus) { %>
                            <div class="card">
                                <h3 class="card-title">üì± √âtat de l'appareil local</h3>
                                
                                <% if (deviceStatus.authenticated) { %>
                                    <div class="status authenticated" style="background: #d4edda; border: 2px solid #28a745; padding: 15px; border-radius: 5px;">
                                        <h4>‚úÖ Appareil connect√©</h4>
                                        <p>Utilisateur: <%= deviceStatus.user.email || deviceStatus.user.preferred_username %></p>
                                        <p>ID: <%= deviceStatus.user.sub %></p>
                                    </div>
                                <% } else if (deviceStatus.pending) { %>
                                    <div class="status pending" style="background: #fef5e7; border: 2px solid #f39c12; padding: 15px; border-radius: 5px;">
                                        <h4>‚è≥ Authentification en cours...</h4>
                                        <p>Code: <strong style="font-size: 1.5rem;"><%= deviceStatus.user_code %></strong></p>
                                        <p>URL: <%= deviceStatus.verification_uri %></p>
                                    </div>
                                <% } else { %>
                                    <div class="status waiting" style="background: #f0f4f8; border: 2px solid #cbd5e0; padding: 15px; border-radius: 5px;">
                                        <h4>üí§ Aucune authentification active</h4>
                                        <p>Allez sur <a href="https://localhost:4000" target="_blank">https://localhost:4000</a> pour d√©marrer</p>
                                    </div>
                                <% } %>
                                
                                <button onclick="checkDeviceStatus()" class="btn btn-primary" style="margin-top: 15px;">
                                    üîÑ Actualiser le statut
                                </button>
                            </div>
                            
                            <script>
                                async function checkDeviceStatus() {
                                    try {
                                        const response = await fetch('https://localhost:4000/api/status', {
                                            mode: 'cors'
                                        });
                                        const data = await response.json();
                                        
                                        // Recharger la page pour afficher le nouveau statut
                                        location.reload();
                                    } catch (error) {
                                        console.error('Erreur:', error);
                                        alert('Impossible de contacter device-app. V√©rifiez qu\'elle est d√©marr√©e sur https://localhost:4000');
                                    }
                                }
                                
                                // Auto-refresh toutes les 5 secondes si en attente
                                <% if (deviceStatus && deviceStatus.pending) { %>
                                setInterval(() => {
                                    checkDeviceStatus();
                                }, 5000);
                                <% } %>
                            </script>
                        <% } else { %>
                            <div class="info-box">
                                <div class="info-icon">‚ö†Ô∏è</div>
                                <div class="info-content">
                                    <h4>Device App non disponible</h4>
                                    <p>D√©marrez device-app sur https://localhost:4000 pour g√©rer les appareils</p>
                                </div>
                            </div>
                        <% } %>
                        <p>Le Device Flow sera impl√©ment√© dans la prochaine √©tape du projet.</p>
                    </div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üîó</div>
                    <h3>Association d'appareils</h3>
                    <p>Connectez vos appareils embarqu√©s (Raspberry Pi, box TV, etc.) sans clavier via un code
                        d'appairage</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîç</div>
                    <h3>Liste des appareils</h3>
                    <p>Visualisez tous les appareils associ√©s √† votre compte avec leur statut et derni√®re connexion</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ùå</div>
                    <h3>R√©vocation</h3>
                    <p>R√©voquez l'acc√®s √† distance de n'importe quel appareil en un clic pour renforcer votre s√©curit√©
                    </p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Historique</h3>
                    <p>Consultez l'historique des connexions et des activit√©s de chaque appareil</p>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Prochaines √©tapes</h3>
                <ul class="checklist">
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Configurer le client "devicecis" dans Keycloak avec Device Authorization Grant
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        D√©velopper l'application embarqu√©e (Raspberry Pi / PC)
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Impl√©menter l'affichage du QR code pour faciliter l'appairage
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Cr√©er l'interface de gestion des appareils sur cette page
                    </li>
                    <li class="pending">
                        <span class="checkbox">‚òê</span>
                        Ajouter la fonctionnalit√© de r√©vocation de tokens
                    </li>
                </ul>
            </div>
        </main>

        <%- include('../partials/footer') %>

            <script src="/js/main.js"></script>
</body>

</html>